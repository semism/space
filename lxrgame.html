<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Game Console</title>
    <style>
        body {
            font-family: monospace;
            background-color: #333;
            color: #eee;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            /* Prevent horizontal scrollbar */
            display: flex;
        }

        #left {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 400px;
            /* Adjust the width of the left section */
        }

        #right {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #444;
            padding: 20px;
            color: #eee;
            box-sizing: border-box;
        }

        #console {
            flex: 1;
            overflow-y: scroll;
            padding: 10px;
            border: 1px solid #666;
            background-color: #222;
            box-sizing: border-box;

            /* WebKit scrollbar styling */
            scrollbar-color: #555 #333;
            /* Firefox scrollbar color */
            scrollbar-width: thin;
            /* Firefox scrollbar width */
        }

        #console::-webkit-scrollbar {
            width: 12px;
            /* Width of the scrollbar */
        }

        #console::-webkit-scrollbar-track {
            background: #333;
            /* Background color of the track */
        }

        #console::-webkit-scrollbar-thumb {
            background: #555;
            /* Color of the draggable part of the scrollbar */
            border-radius: 6px;
            /* Rounded corners for the scrollbar thumb */
        }

        #console::-webkit-scrollbar-thumb:hover {
            background: #777;
            /* Color when hovering over the scrollbar thumb */
        }

        #input {
            width: 100%;
            padding: 10px;
            border: none;
            background-color: #444;
            color: #eee;
            font-size: 1em;
            box-sizing: border-box;
        }

        .player-input {
            color: rgb(169, 230, 28);
        }

        .info {
            color: #0ff;
        }

        .error {
            color: #f00;
        }

        .success {
            color: #0f0;
        }

        .computer {
            color: #f0f;
        }

        .visual {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .card {
            width: 40px;
            height: 60px;
            background-color: #222;
            color: #eee;
            text-align: center;
            line-height: 60px;
            border: 1px solid #666;
            box-sizing: border-box;
        }

        .hand,
        .middle,
        .arrangement {
            margin-bottom: 20px;
        }

        .score {
            font-size: 1.2em;
            margin-top: 20px;
        }

        .next-round {
            font-size: 1.5em;
            margin-top: 20px;
            text-align: center;
        }

        .total-score {
            font-size: 1.2em;
            margin-top: 20px;
            text-align: center;
            color: #0ff;
        }
    </style>


</head>

<body>
    <div id="left">
        <div id="console"></div>
        <input type="text" id="input" autofocus placeholder="Type your command here...">
    </div>
    <div id="right">
        <div class="visual">
            <div id="hand" class="hand">
                <div class="card-row" id="hand-cards"></div>
            </div>
            <div id="middle" class="middle">
                <div class="card-row" id="middle-cards"></div>
            </div>
            <div id="arrangement" class="arrangement">
                <div class="card-row" id="arrangement-cards"></div>
            </div>
            <div id="score" class="score">
                <span id="player-score">Your Round Score: 0</span><br>
                <span id="computer-score">Computer Round Score: 0</span><br>
                <span id="player-total-score" class="info">Your Total Score: 0</span><br>
                <span id="computer-total-score" class="computer">Computer Total Score: 0</span>
            </div>
            <div id="next-round" class="next-round"></div>
        </div>
    </div>
    <script>
        // Define card types and point values
        const LEFT = '<';
        const RIGHT = '>';
        const WRONG = 'X';

        const CARD_TYPES = [LEFT, RIGHT, WRONG];
        const POINTS = {
            '<leftmost': 5,
            '<chained': 2,
            '<elsewhere': 1,
            '>rightmost': 5,
            '>chained': 3,
            '>elsewhere': 1
        };

        // Deck creation and shuffling
        function createDeck() {
            return Array(12).fill(LEFT).concat(Array(12).fill(RIGHT)).concat(Array(12).fill(WRONG));
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        // Deal cards to players
        function dealCards(deck, numCards = 5) {
            return Array.from({ length: numCards }, () => deck.pop());
        }

        // Print the cards in hand and in the middle
        function printGameState(playerHand, middleCards) {
            appendToConsole(`Your hand: <span class="info">${playerHand.join(' ')}</span>`);
            appendToConsole(`Middle cards: <span class="info">${middleCards.join(' ')}</span>`);
        }

        // Function to evaluate the score
        function calculateScore(arrangement) {
            arrangement = twoWrongsMakeARight(arrangement);
            appendToConsole(`<span>------------------------</span>`);
            let score = 0;
            let breakdown = [];
            arrangement.forEach((card, idx) => {
                let points = 0;
                if (card === LEFT) {
                    if (idx === 0) {
                        points = POINTS['<leftmost'];
                    } else if (arrangement[idx - 1] === LEFT) {
                        points = POINTS['<chained'];
                    } else {
                        points = POINTS['<elsewhere'];
                    }
                } else if (card === RIGHT) {
                    if (idx === arrangement.length - 1) {
                        points = POINTS['>rightmost'];
                    } else if (arrangement[idx + 1] === RIGHT) {
                        points = POINTS['>chained'];
                    } else {
                        points = POINTS['>elsewhere'];
                    }
                } else {
                    points = 0;
                }
                score += points;
                breakdown.push(points);
            });

            appendToConsole(`&nbspCards: <span class="info">${arrangement.join(' ')}</span>`);
            appendToConsole(`Points: <span class="info">${breakdown.join(' ')}</span>`);
            return score;
        }

        function twoWrongsMakeARight(arrangement) {
            const newArrangement = [];
            for (let i = 0; i < arrangement.length; i++) {
                const card = arrangement[i];
                if (card === WRONG) {
                    if ((i === 0 && arrangement[i + 1] === WRONG) ||
                        (i < arrangement.length - 1 && arrangement[i + 1] === WRONG)) {
                        newArrangement.push(RIGHT);
                    } else {
                        newArrangement.push(WRONG)
                    }
                } else {
                    newArrangement.push(card);
                }
            }
            return newArrangement;
        }

        function isValidArrangement(arrangement, hand, middleCards) {
            const availableCards = middleCards.concat(hand);
            return (arrangement.length === 7 &&
                arrangement.every(card => availableCards.includes(card)) &&
                arrangement.toSorted().join('') === availableCards.toSorted().join(''));
        }

        function getPlayerArrangement(playerHand, middleCards) {
            return new Promise((resolve) => {
                appendToConsole("Enter your arrangement of 7 cards (e.g., '< < X > > <'):", "info");
                document.getElementById('input').addEventListener('keydown', function handleEnter(event) {
                    if (event.key === 'Enter') {
                        const input = event.target.value.toUpperCase().split("").filter(i => !i.match(/\s+/));
                        appendToConsole(`<span class="player-input">${event.target.value}</span>`, "player-input"); // Append player input
                        event.target.value = ''; // Clear input

                        if (!isValidArrangement(input, playerHand, middleCards)) {
                            appendToConsole("Invalid arrangement. Try again.", "error");
                            return;
                        }

                        let cursorIdx = 0;
                        for (const card of middleCards) {
                            if (!input.slice(cursorIdx).includes(card)) {
                                appendToConsole("Invalid arrangement. Order of middle cards was not preserved!", "error");
                                return;
                            }
                            cursorIdx = input.indexOf(card, cursorIdx);
                        }
                        document.getElementById('input').removeEventListener('keydown', handleEnter);
                        resolve(input);
                    }
                });
            });
        }

        function updateVisuals(playerHand, middleCards, playerArrangement, playerScore, computerScore) {
            // Update the right side with visual representations
            const handCards = document.getElementById('hand-cards');
            const middleCardsElem = document.getElementById('middle-cards');
            const arrangementCards = document.getElementById('arrangement-cards');
            const playerScoreElem = document.getElementById('player-score');
            const computerScoreElem = document.getElementById('computer-score');

            // Clear previous visuals
            handCards.innerHTML = '';
            middleCardsElem.innerHTML = '';
            arrangementCards.innerHTML = '';

            // Display player hand
            playerHand.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card';
                div.textContent = card;
                handCards.appendChild(div);
            });

            // Display middle cards
            middleCards.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card';
                div.textContent = card;
                middleCardsElem.appendChild(div);
            });

            // Display player arrangement
            playerArrangement.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card';
                div.textContent = card;
                arrangementCards.appendChild(div);
            });

            // Update scores
            playerScoreElem.textContent = `Your Round Score: ${playerScore}`;
            computerScoreElem.textContent = `Computer Round Score: ${computerScore}`;
        }

        function promptNextRound() {
            return new Promise((resolve) => {
                const nextRoundElem = document.getElementById('next-round');
                nextRoundElem.textContent = 'Type anything and press Enter to start the next round...';

                document.getElementById('input').addEventListener('keydown', function handleStartRound(event) {
                    if (event.key === 'Enter') {
                        nextRoundElem.textContent = '';
                        document.getElementById('input').removeEventListener('keydown', handleStartRound);
                        resolve();
                    }
                });
            });
        }

        // Game setup
        function setupGame() {
            const deck = shuffleDeck(createDeck());
            const playerHand = dealCards(deck);
            const middleCards = [deck.pop(), deck.pop()];
            return { deck, playerHand, middleCards };
        }

        // Simulate a round of play
        async function playRound(playerHand, middleCards, deck) {
            printGameState(playerHand, middleCards);

            // Initialize visuals
            updateVisuals(playerHand, middleCards, [], 0, 0);

            // Player discards one card
            appendToConsole("Discard one card from your hand:", "info");
            const discard = await new Promise((resolve) => {
                document.getElementById('input').addEventListener('keydown', function handleEnter(event) {
                    if (event.key === 'Enter') {
                        const card = event.target.value.toUpperCase();
                        appendToConsole(`<span class="player-input">${event.target.value}</span>`, "player-input"); // Append player input
                        event.target.value = ''; // Clear input

                        if (!playerHand.includes(card)) {
                            appendToConsole("Invalid card. Try again.", "error");
                            return;
                        }
                        playerHand.splice(playerHand.indexOf(card), 1);
                        document.getElementById('input').removeEventListener('keydown', handleEnter);
                        resolve(card);
                    }
                });
            });

            // Place an additional card in the middle
            middleCards.push(deck.pop());

            printGameState(playerHand, middleCards);

            // Initialize visuals with updated game state
            updateVisuals(playerHand, middleCards, [], 0, 0);

            // Get player arrangement
            const playerArrangement = await getPlayerArrangement(playerHand, middleCards);

            // Compute scores
            const playerScore = calculateScore(playerArrangement);
            const computerArrangement = middleCards.concat(Array(3).fill(LEFT));
            const computerScore = calculateScore(computerArrangement);

            // Update visuals with final arrangement and scores
            updateVisuals(playerHand, middleCards, playerArrangement, playerScore, computerScore);

            appendToConsole(`Your score: <span class="success">${playerScore}</span>`, "success");
            appendToConsole(`Computer score: <span class="computer">${computerScore}</span>`, "computer");

            return { playerScore, computerScore };
        }

        // Main game loop
        async function main() {
            const numRounds = 5;
            let totalPlayerScore = 0;
            let totalComputerScore = 0;

            for (let roundNum = 0; roundNum < numRounds; roundNum++) {
                appendToConsole(`Round ${roundNum + 1}`, "info");
                const { deck, playerHand, middleCards } = setupGame();
                const { playerScore, computerScore } = await playRound(playerHand, middleCards, deck);
                totalPlayerScore += playerScore;
                totalComputerScore += computerScore;

                const playerTotalScoreElem = document.getElementById('player-total-score');
                const computerTotalScoreElem = document.getElementById('computer-total-score');
                playerTotalScoreElem.textContent = `Your Total Score: ${totalPlayerScore}`;
                playerTotalScoreElem.textContent = `Your Total Score: ${totalComputerScore}`;

                // Prompt the player to start the next round
                await promptNextRound();
            }

            appendToConsole(`Final Scores: Player <span class="success">${totalPlayerScore}</span>, Computer <span class="computer">${totalComputerScore}</span>`, "info");
            if (totalPlayerScore > totalComputerScore) {
                appendToConsole("You win!", "success");
            } else if (totalPlayerScore < totalComputerScore) {
                appendToConsole("Computer wins!", "error");
            } else {
                appendToConsole("It's a tie!", "info");
            }
        }

        function appendToConsole(message, className = "") {
            const consoleDiv = document.getElementById('console');
            const p = document.createElement('p');
            p.className = className;
            p.innerHTML = message;
            consoleDiv.appendChild(p);
            consoleDiv.scrollTop = consoleDiv.scrollHeight; // Scroll to bottom
        }

        // Start the game
        main();
    </script>
</body>

</html>